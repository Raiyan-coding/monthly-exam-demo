<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ahoron — Results</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .results-list{list-style:none;padding:0}
    .month-card{margin-bottom:16px}
    .rank-row{display:flex;gap:12px;align-items:center;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:6px}
    .rank {font-weight:700;width:36px}
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <div class="brand">Ahoron — Results</div>
      <div class="small">See monthly standings and per-subject rankings</div>
    </div>
  </header>
  <main class="container">
    <h2>Monthly Results</h2>
    <div id="months"></div>
  </main>
  <footer class="site-footer">Built for Ahoron</footer>
  <script>
    async function loadResults(){
      try{
        const r = await fetch('./result.json', {cache:'no-store'});
        if(!r.ok) throw new Error('Could not load result.json');
        const data = await r.json();
        render(data);
      }catch(e){ document.getElementById('months').textContent = 'Error loading results: '+e.message }
    }

    function render(data){
      const root = document.getElementById('months');
      root.innerHTML = '';
      (data.months||[]).forEach(m => {
        const card = document.createElement('div');
        card.className = 'month-card';
        const h = document.createElement('h3'); h.textContent = m.label + ' ('+m.monthId+')'; card.appendChild(h);
        (m.subjects||[]).forEach(sub => {
          const subH = document.createElement('h4'); subH.textContent = sub.subjectName; card.appendChild(subH);
          const ul = document.createElement('div');
          // build standings by correctCount desc, timeTaken asc
          const standings = (sub.submissions||[]).slice().sort((a,b)=>{
            if((b.correctCount||0) - (a.correctCount||0) !== 0) return (b.correctCount||0) - (a.correctCount||0);
            return (a.timeTakenSec||0) - (b.timeTakenSec||0);
          });
          standings.forEach((s,i)=>{
            const row = document.createElement('div'); row.className = 'rank-row';
            row.innerHTML = `<div class="rank">${i+1}</div>
              <div style="flex:1">${escapeHtml(s.studentName||s.studentEmail||'Anonymous')}</div>
              <div style="width:140px;text-align:right">${s.correctCount||0}/${s.totalQuestions||0}</div>
              <div style="width:140px;text-align:right">${s.timeTakenSec||0}s</div>`;
            row.addEventListener('click', ()=>{
              const details = document.createElement('pre'); details.textContent = JSON.stringify(s.resultSheet||{},null,2); details.style.marginTop='8px';
              if(row.nextSibling && row.nextSibling.tagName==='PRE') row.parentNode.removeChild(row.nextSibling);
              else row.parentNode.insertBefore(details, row.nextSibling);
            });
            ul.appendChild(row);
          });
          card.appendChild(ul);
        });
        root.appendChild(card);
      });
    }

    function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    loadResults();
  </script>
</body>
</html>
